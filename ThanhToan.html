<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thanh To√°n - Nh√† H√†ng ·∫®m Th·ª±c Ph∆∞∆°ng Nam</title>
    <link rel="icon" href="img/logoPN.png" type="image/png">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #e53e3e;
        }
        .bg-primary { background-color: var(--primary-color); }
        .text-primary { color: var(--primary-color); }
    </style>
</head>
<body class="bg-gray-100 min-h-screen py-8">
    <div class="container mx-auto px-4">
        <div class="max-w-2xl mx-auto bg-white rounded-lg shadow-md p-6">
            <div class="text-center mb-6">
                <a href="Menu-new.html" class="text-primary hover:underline">
                    <i class="fas fa-arrow-left"></i> Quay l·∫°i Th·ª±c ƒë∆°n
                </a>
                <h1 class="text-3xl font-bold text-gray-800 mt-2">THANH TO√ÅN ƒê∆†N H√ÄNG</h1>
            </div>
            
            <!-- Th√¥ng tin kh√°ch h√†ng -->
            <div class="mb-6 p-4 bg-indigo-50 rounded-lg border border-indigo-200">
                <h2 class="text-xl font-semibold text-indigo-700 mb-2">Th√¥ng Tin Kh√°ch H√†ng</h2>
                <p><strong>T√™n:</strong> <span id="customerName">ƒêang t·∫£i...</span></p>
                <p><strong>Email:</strong> <span id="customerEmail">ƒêang t·∫£i...</span></p>
                <p><strong>ID Kh√°ch h√†ng:</strong> <span id="customerId">ƒêang t·∫£i...</span></p>
                <div class="mt-2 p-2 bg-green-100 border border-green-300 rounded">
                    <i class="fas fa-info-circle text-green-600"></i>
                    <span class="text-green-700 text-sm">Th√¥ng tin n√†y s·∫Ω ƒë∆∞·ª£c s·ª≠ d·ª•ng t·ª± ƒë·ªông cho h√≥a ƒë∆°n</span>
                </div>
            </div>

            <!-- Gi·ªè h√†ng -->
            <div class="mb-6 p-4 bg-gray-50 rounded-lg border">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-gray-700">Chi Ti·∫øt ƒê∆°n H√†ng</h2>
                    <div class="space-x-2">
                        <button onclick="debugReloadCart()" class="px-3 py-1 bg-blue-500 text-white text-sm rounded hover:bg-blue-600">
                            <i class="fas fa-sync-alt mr-1"></i> Reload Cart
                        </button>
                        <button onclick="debugShowAllCarts()" class="px-3 py-1 bg-green-500 text-white text-sm rounded hover:bg-green-600">
                            <i class="fas fa-users mr-1"></i> Show All Carts
                        </button>
                        <button onclick="cleanupGuestCarts()" class="px-3 py-1 bg-red-500 text-white text-sm rounded hover:bg-red-600">
                            <i class="fas fa-trash mr-1"></i> Clean Guest Carts
                        </button>
                    </div>
                </div>
                <div id="cartItems" class="space-y-3">
                    <!-- Items will be loaded here -->
                </div>
                <div class="mt-4 pt-4 border-t space-y-2">
                    <div class="flex justify-between">
                        <span class="text-gray-600">T·∫°m t√≠nh:</span>
                        <span id="subtotal" class="font-semibold">185,000ƒë</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Ph√≠ giao h√†ng:</span>
                        <span id="deliveryFee" class="font-semibold">0ƒë</span>
                    </div>
                    <div class="flex justify-between text-xl font-bold border-t pt-2 mt-2">
                        <span class="text-gray-800">T·ªïng c·ªông:</span>
                        <span id="totalAmount" class="text-red-600">185,000ƒë</span>
                    </div>
                </div>
            </div>

            <!-- Form thanh to√°n -->
            <form id="paymentForm" class="space-y-6">
                <!-- Ph∆∞∆°ng th·ª©c nh·∫≠n h√†ng -->
                <div>
                    <h3 class="text-lg font-semibold mb-3">Ph∆∞∆°ng Th·ª©c Nh·∫≠n H√†ng</h3>
                    <div class="space-y-2">
                        <label class="flex items-center">
                            <input type="radio" name="orderType" value="tai_cho" checked class="mr-2">
                            <i class="fas fa-utensils mr-2"></i>
                            <span>ƒÇn t·∫°i nh√† h√†ng</span>
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="orderType" value="giao_hang" class="mr-2">
                            <i class="fas fa-truck mr-2"></i>
                            <span>Giao h√†ng t·∫≠n n∆°i (+20,000ƒë)</span>
                        </label>
                    </div>
                </div>

                <!-- ƒê·ªãa ch·ªâ giao h√†ng -->
                <div id="deliveryAddressSection" class="hidden">
                    <label for="deliveryAddress" class="block text-sm font-medium text-gray-700 mb-2">
                        ƒê·ªãa ch·ªâ giao h√†ng
                    </label>
                    <textarea id="deliveryAddress" name="deliveryAddress" rows="3" 
                              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500"
                              placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ giao h√†ng chi ti·∫øt..."></textarea>
                </div>

                <!-- Ph∆∞∆°ng th·ª©c thanh to√°n -->
                <div>
                    <h3 class="text-lg font-semibold mb-3">Ph∆∞∆°ng Th·ª©c Thanh To√°n</h3>
                    <div class="space-y-3">
                        <label class="flex items-center p-3 border border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50">
                            <input type="radio" name="paymentMethod" value="cash" checked class="mr-3">
                            <i class="fas fa-money-bill-wave text-green-600 mr-3"></i>
                            <div>
                                <span class="font-medium">Thanh to√°n ti·ªÅn m·∫∑t</span>
                                <p class="text-sm text-gray-500">Thanh to√°n khi nh·∫≠n h√†ng</p>
                            </div>
                        </label>
                        <label class="flex items-center p-3 border border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50">
                            <input type="radio" name="paymentMethod" value="bank_transfer" class="mr-3">
                            <i class="fas fa-university text-blue-600 mr-3"></i>
                            <div>
                                <span class="font-medium">Chuy·ªÉn kho·∫£n ng√¢n h√†ng</span>
                                <p class="text-sm text-gray-500">Chuy·ªÉn kho·∫£n tr∆∞·ªõc khi nh·∫≠n h√†ng</p>
                            </div>
                        </label>
                    </div>
                </div>

                <!-- Th√¥ng tin chuy·ªÉn kho·∫£n -->
                <div id="bankTransferSection" class="hidden bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <h4 class="font-semibold text-blue-800 mb-3">
                        <i class="fas fa-info-circle mr-2"></i>
                        Th√¥ng Tin Chuy·ªÉn Kho·∫£n
                    </h4>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span class="text-gray-600">Ng√¢n h√†ng:</span>
                            <span class="font-medium">Vietcombank</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">S·ªë t√†i kho·∫£n:</span>
                            <span class="font-medium">1234567890</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Ch·ªß t√†i kho·∫£n:</span>
                            <span class="font-medium">Nh√† H√†ng ·∫®m Th·ª±c Ph∆∞∆°ng Nam</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">N·ªôi dung:</span>
                            <span class="font-medium" id="transferContent">HD000001 - T√™n kh√°ch h√†ng</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">S·ªë ti·ªÅn:</span>
                            <span class="font-bold text-red-600" id="transferAmount">0ƒë</span>
                        </div>
                    </div>

                    <div class="mt-4 p-3 bg-yellow-50 border border-yellow-200 rounded">
                        <p class="text-sm text-yellow-800">
                            <i class="fas fa-exclamation-triangle mr-2"></i>
                            <strong>L∆∞u √Ω:</strong> Vui l√≤ng chuy·ªÉn kho·∫£n ƒë√∫ng s·ªë ti·ªÅn v√† n·ªôi dung.
                            ƒê∆°n h√†ng s·∫Ω ƒë∆∞·ª£c x·ª≠ l√Ω sau khi nh·∫≠n ƒë∆∞·ª£c thanh to√°n.
                        </p>
                    </div>

                    <!-- Upload ·∫£nh chuy·ªÉn kho·∫£n -->
                    <div class="mt-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-camera mr-2"></i>
                            T·∫£i l√™n ·∫£nh chuy·ªÉn kho·∫£n <span class="text-red-500">*</span>
                        </label>
                        <input type="file" id="transferProof" name="transferProof" accept="image/*"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <p class="text-xs text-red-600 mt-1">
                            <i class="fas fa-exclamation-triangle mr-1"></i>
                            <strong>B·∫Øt bu·ªôc:</strong> Vui l√≤ng t·∫£i l√™n ·∫£nh chuy·ªÉn kho·∫£n ƒë·ªÉ x√°c nh·∫≠n thanh to√°n
                        </p>
                        <p class="text-xs text-gray-500 mt-1">H·ªó tr·ª£: JPG, PNG, GIF (t·ªëi ƒëa 5MB)</p>
                    </div>
                </div>

                <!-- Ghi ch√∫ -->
                <div>
                    <label for="orderNotes" class="block text-sm font-medium text-gray-700 mb-2">
                        Ghi ch√∫ ƒë∆°n h√†ng (t√πy ch·ªçn)
                    </label>
                    <textarea id="orderNotes" name="orderNotes" rows="3"
                              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500"
                              placeholder="Ghi ch√∫ v·ªÅ ƒë∆°n h√†ng..."></textarea>
                </div>

                <!-- N√∫t thanh to√°n -->
                <button type="submit" id="submitOrderBtn" 
                        class="w-full bg-red-600 text-white py-3 px-4 rounded-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 font-semibold text-lg">
                    <i class="fas fa-credit-card mr-2"></i>
                    X√°c Nh·∫≠n Thanh To√°n
                </button>
            </form>
        </div>
    </div>

    <!-- Success Modal -->
    <div id="successModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg p-8 max-w-md mx-4 text-center">
            <div class="mb-6">
                <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-check text-green-600 text-3xl"></i>
                </div>
                <h2 class="text-2xl font-bold text-gray-800 mb-2">C·∫£m ∆°n b·∫°n ƒë√£ s·ª≠ d·ª•ng d·ªãch v·ª•!</h2>
                <p class="text-gray-600 mb-4">M√£ h√≥a ƒë∆°n: <span id="invoiceNumber" class="font-semibold text-blue-600">#HD000001</span></p>
            </div>

            <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-6">
                <div class="flex items-center justify-center mb-2">
                    <i class="fas fa-heart text-red-500 mr-2"></i>
                    <span class="font-semibold text-green-800">C·∫£m ∆°n b·∫°n ƒë√£ tin t∆∞·ªüng nh√† h√†ng!</span>
                </div>
                <p class="text-sm text-green-700">
                    ƒê∆°n h√†ng c·ªßa b·∫°n ƒë√£ ƒë∆∞·ª£c ghi nh·∫≠n v√† ƒëang ch·ªù nh√¢n vi√™n x√°c nh·∫≠n. Ch√∫ng t√¥i s·∫Ω li√™n h·ªá v·ªõi b·∫°n s·ªõm nh·∫•t ƒë·ªÉ th√¥ng b√°o t√¨nh tr·∫°ng ƒë∆°n h√†ng.
                </p>
            </div>

            <div class="space-y-3">
                <button onclick="closeSuccessModal()"
                        class="w-full bg-green-600 text-white py-3 px-4 rounded-md hover:bg-green-700 transition-colors duration-300 font-semibold">
                    <i class="fas fa-utensils mr-2"></i>
                    Quay l·∫°i Menu
                </button>
                <div class="text-sm text-gray-500">
                    <p>Ch√∫ng t√¥i r·∫•t tr√¢n tr·ªçng s·ª± ·ªßng h·ªô c·ªßa b·∫°n! üôè</p>
                    <p id="autoRedirectCountdown" class="mt-2 text-xs">
                        T·ª± ƒë·ªông quay l·∫°i menu sau <span id="countdownTimer">10</span> gi√¢y...
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Floating contact buttons -->
    <div class="fixed left-4 bottom-4 space-y-4 z-50">
        <div class="floating-btn">
            <a href="tel:+84123456789" class="phone-btn block">
                <div class="w-16 h-16 bg-red-500 rounded-full flex items-center justify-center text-white text-2xl hover:bg-red-600 transition-all duration-300 shadow-lg">
                    <i class="fas fa-phone"></i>
                </div>
            </a>
        </div>
        <div class="floating-btn">
            <a href="https://zalo.me/0123456789" target="_blank" class="zalo-btn block">
                <div class="w-16 h-16 bg-blue-500 rounded-full flex items-center justify-center text-white text-2xl hover:bg-blue-600 transition-all duration-300 shadow-lg">
                    <i class="fab fa-facebook-messenger"></i>
                </div>
            </a>
        </div>
    </div>

    <style>
    .floating-btn {
        position: relative;
        animation: float 4s ease-in-out infinite;
        filter: drop-shadow(0 10px 20px rgba(0, 0, 0, 0.15));
    }
    .floating-btn:nth-child(1) { animation-delay: -0.5s; }
    .floating-btn:nth-child(2) { animation-delay: -2s; }
    @keyframes float {
        0%, 100% { transform: translateY(0px) rotate(0deg); }
        25% { transform: translateY(-8px) rotate(1deg); }
        50% { transform: translateY(-15px) rotate(0deg); }
        75% { transform: translateY(-8px) rotate(-1deg); }
    }
    .zalo-btn:hover .w-16 {
        box-shadow: 0 0 30px rgba(59, 130, 246, 0.8), 0 0 60px rgba(59, 130, 246, 0.4);
    }
    .phone-btn:hover .w-16 {
        box-shadow: 0 0 30px rgba(239, 68, 68, 0.8), 0 0 60px rgba(239, 68, 68, 0.4);
    }

    /* Modal animations */
    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: scale(0.9);
        }
        to {
            opacity: 1;
            transform: scale(1);
        }
    }

    @keyframes fadeOut {
        from {
            opacity: 1;
            transform: scale(1);
        }
        to {
            opacity: 0;
            transform: scale(0.9);
        }
    }

    /* Success modal styling */
    #successModal {
        backdrop-filter: blur(5px);
    }

    #successModal .bg-white {
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        animation: slideInUp 0.4s ease-out;
    }

    @keyframes slideInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    </style>

    <!-- Load cart system -->
    <script src="js/cart.js"></script>
    <script src="js/user-cart-integration.js"></script>

    <script>
        // Real cart data from CartManager
        let cartItems = [];
        let customerInfo = null;

        // Get current user ID for cart separation
        function getCurrentUserId() {
            try {
                const user = localStorage.getItem('user') || localStorage.getItem('userData');
                console.log('üîç getUserId - raw user data:', user);
                if (user) {
                    const userData = JSON.parse(user);
                    console.log('üîç getUserId - parsed userData:', userData);
                    const userId = userData.id || userData.email || null; // Kh√¥ng tr·∫£ v·ªÅ 'guest'
                    console.log('üîç getUserId - final userId:', userId);
                    return userId;
                }
                console.log('üîç getUserId - no user data, returning null');
                return null; // Kh√¥ng c√≥ user th√¨ tr·∫£ v·ªÅ null
            } catch (error) {
                console.error('Error getting current user ID:', error);
                return null;
            }
        }

        // Load real customer info from CartManager
        function loadCustomerInfo() {
            console.log('üîç Loading customer info...');

            // Get customer info from CartManager
            if (window.cartManager) {
                customerInfo = window.cartManager.customerInfo;
                console.log('‚úÖ Got customer info from CartManager:', customerInfo);
                console.log('üë§ Current user ID:', window.cartManager.currentUserId);
            } else {
                // Fallback to localStorage - try user-specific first
                try {
                    const currentUserId = getCurrentUserId();
                    const customerInfoKey = `customerInfo_${currentUserId}`;
                    customerInfo = JSON.parse(localStorage.getItem(customerInfoKey)) ||
                                  JSON.parse(localStorage.getItem('customerInfo'));
                    console.log('‚úÖ Got customer info from localStorage:', customerInfo);
                } catch (error) {
                    console.warn('‚ö†Ô∏è Error loading customer info from localStorage:', error);
                }
            }

            // Use customer info directly without API calls
            if (customerInfo && customerInfo.id) {
                updateUIWithCurrentCustomerInfo();
            } else {
                // Show default guest info
                document.getElementById('customerName').textContent = 'Kh√°ch h√†ng';
                document.getElementById('customerEmail').textContent = 'guest@restaurant.com';
                document.getElementById('customerId').textContent = 'N/A';

                // Set default customer info for payment
                customerInfo = {
                    id: 6, // Default to customer ID 6
                    full_name: 'Nguy·ªÖn Hu·ª≥nh K·ª≥ Thu·∫≠t Thu·∫≠t',
                    email: 'nguyenhuynhkithuat84tv@gmail.com',
                    phone: '0123456789'
                };

                // Update UI with default customer info
                updateUIWithCurrentCustomerInfo();
            }
        }



        // Update UI with current customer info
        function updateUIWithCurrentCustomerInfo() {
            if (customerInfo) {
                document.getElementById('customerName').textContent = customerInfo.full_name || customerInfo.name || 'N/A';
                document.getElementById('customerEmail').textContent = customerInfo.email || 'N/A';
                document.getElementById('customerId').textContent = customerInfo.id ? `#${customerInfo.id}` : 'N/A';
            }
        }

        // Load real cart items from CartManager
        function loadCartItems() {
            console.log('üîç Loading cart items...');

            // Ki·ªÉm tra ƒëƒÉng nh·∫≠p tr∆∞·ªõc
            const currentUserId = getCurrentUserId();
            if (!currentUserId) {
                console.log('‚ùå No user logged in, cannot load cart');
                cartItems = [];
                const cartContainer = document.getElementById('cartItems');
                cartContainer.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <i class="fas fa-user-lock text-4xl mb-4"></i>
                        <p>Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ xem gi·ªè h√†ng</p>
                        <a href="Menu-new.html" class="text-red-600 hover:underline mt-2 inline-block">
                            <i class="fas fa-arrow-left mr-1"></i> Quay l·∫°i th·ª±c ƒë∆°n
                        </a>
                    </div>
                `;
                return;
            }

            console.log('üîç Available localStorage keys:', Object.keys(localStorage));

            // Debug all possible cart sources
            const cartKey = `cart_${currentUserId}`;
            console.log('üîç Current user ID:', currentUserId);
            console.log('üîç Cart key:', cartKey);
            console.log('üîç localStorage cart_user:', localStorage.getItem(cartKey));
            console.log('üîç localStorage cart:', localStorage.getItem('cart'));

            // Get cart data from CartManager
            if (window.cartManager && window.cartManager.currentUserId) {
                cartItems = window.cartManager.getCart();
                console.log('‚úÖ Got cart from CartManager:', cartItems);
                console.log('üë§ Cart for user:', window.cartManager.currentUserId);
            } else {
                // Fallback to localStorage - ch·ªâ load cart c·ªßa user ƒë√£ ƒëƒÉng nh·∫≠p
                cartItems = JSON.parse(localStorage.getItem(cartKey)) || [];
                console.log(`‚úÖ Got cart from localStorage for user ${currentUserId}:`, cartItems);
            }

            console.log('üõí Final cartItems:', cartItems);
            console.log('üõí cartItems length:', cartItems.length);

            const cartContainer = document.getElementById('cartItems');
            cartContainer.innerHTML = '';

            if (cartItems.length === 0) {
                cartContainer.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <i class="fas fa-shopping-cart text-4xl mb-4"></i>
                        <p>Ch∆∞a c√≥ m√≥n ƒÉn n√†o ƒë∆∞·ª£c ch·ªçn</p>
                        <a href="Menu-new.html" class="text-red-600 hover:underline mt-2 inline-block">
                            <i class="fas fa-arrow-left mr-1"></i> Quay l·∫°i th·ª±c ƒë∆°n
                        </a>
                    </div>
                `;
                return;
            }

            cartItems.forEach(item => {
                // Handle different data formats from cart
                const itemName = item.ten_mon || item.name || 'M√≥n ƒÉn';
                const itemPrice = item.gia || item.price || 0;
                const itemQuantity = item.qty || item.quantity || item.so_luong || 1;
                const itemImage = item.hinh_anh || item.image || 'img/no-image.png';
                const itemId = item.id_mon || item.id || 'unknown';

                console.log('üì¶ Processing item:', {itemName, itemPrice, itemQuantity, itemImage});

                const itemDiv = document.createElement('div');
                itemDiv.className = 'flex justify-between items-center py-2 border-b border-gray-200 last:border-b-0';
                itemDiv.innerHTML = `
                    <div class="flex items-center">
                        <div class="w-12 h-12 bg-gray-200 rounded mr-3 flex items-center justify-center overflow-hidden">
                            <img src="${itemImage}" alt="${itemName}" class="w-full h-full object-cover"
                                 onerror="this.style.display='none'; this.parentElement.innerHTML='<span class=\\'text-xs text-gray-500\\'>üçΩÔ∏è</span>'">
                        </div>
                        <div>
                            <p class="font-semibold text-gray-800">${itemName}</p>
                            <p class="text-sm text-gray-600">S·ªë l∆∞·ª£ng: ${itemQuantity}</p>
                            <p class="text-sm text-blue-600">ƒê∆°n gi√°: ${itemPrice.toLocaleString('vi-VN')}ƒë</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="font-semibold text-lg text-red-600">${(itemPrice * itemQuantity).toLocaleString('vi-VN')}ƒë</p>
                    </div>
                `;
                cartContainer.appendChild(itemDiv);
            });
        }

        // Update totals with real cart data
        function updateTotals() {
            const selectedOrderType = document.querySelector('input[name="orderType"]:checked');
            const deliveryFee = (selectedOrderType && selectedOrderType.value === 'giao_hang') ? 20000 : 0;

            // Calculate subtotal from real cart items
            const subtotal = cartItems.reduce((sum, item) => {
                const itemPrice = item.gia || item.price || 0;
                const itemQuantity = item.qty || item.quantity || item.so_luong || 1;
                return sum + (itemPrice * itemQuantity);
            }, 0);

            const total = subtotal + deliveryFee;

            document.getElementById('subtotal').textContent = `${subtotal.toLocaleString('vi-VN')}ƒë`;
            document.getElementById('deliveryFee').textContent = `${deliveryFee.toLocaleString('vi-VN')}ƒë`;
            document.getElementById('totalAmount').textContent = `${total.toLocaleString('vi-VN')}ƒë`;
        }

        // Handle order type change
        document.querySelectorAll('input[name="orderType"]').forEach(radio => {
            radio.addEventListener('change', function() {
                const deliverySection = document.getElementById('deliveryAddressSection');
                if (this.value === 'giao_hang') {
                    deliverySection.classList.remove('hidden');
                } else {
                    deliverySection.classList.add('hidden');
                }
                updateTotals();
            });
        });

        // Convert file to base64
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }

        // Handle form submission
        document.getElementById('paymentForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            console.log('üîÑ Form submission started');

            const submitBtn = document.getElementById('submitOrderBtn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>ƒêang x·ª≠ l√Ω...';

            try {
                // Debug cart state before checking
                console.log('üîç DEBUG submitPayment - cartItems:', cartItems);
                console.log('üîç DEBUG submitPayment - cartItems type:', typeof cartItems);
                console.log('üîç DEBUG submitPayment - cartItems length:', cartItems ? cartItems.length : 'undefined');
                console.log('üîç DEBUG submitPayment - cartItems is array:', Array.isArray(cartItems));

                // Reload cart items to ensure we have latest data
                loadCartItems();
                console.log('üîç DEBUG after reload - cartItems:', cartItems);
                console.log('üîç DEBUG after reload - cartItems length:', cartItems ? cartItems.length : 'undefined');

                // Check if cart has items
                if (!cartItems || cartItems.length === 0) {
                    console.log('‚ùå Cart is empty, showing alert');
                    alert('‚ö†Ô∏è Ch∆∞a c√≥ m√≥n ƒÉn n√†o!\n\nVui l√≤ng ch·ªçn m√≥n ƒÉn t·ª´ th·ª±c ƒë∆°n tr∆∞·ªõc khi thanh to√°n.');
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<i class="fas fa-credit-card mr-2"></i>X√°c Nh·∫≠n Thanh To√°n';
                    return;
                }

                console.log('‚úÖ Cart has items, proceeding with payment');

                const formData = new FormData(this);
                const orderType = formData.get('orderType');
                const deliveryAddress = formData.get('deliveryAddress');
                const orderNotes = formData.get('orderNotes');
                const paymentMethod = formData.get('paymentMethod');

                console.log('üìã Form data:', {
                    orderType, deliveryAddress, orderNotes, paymentMethod,
                    cartItemsCount: cartItems.length,
                    customerInfo: customerInfo
                });

                // Check customer info
                if (!customerInfo) {
                    alert('‚ö†Ô∏è Kh√¥ng c√≥ th√¥ng tin kh√°ch h√†ng!\n\nVui l√≤ng ki·ªÉm tra l·∫°i.');
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<i class="fas fa-credit-card mr-2"></i>X√°c Nh·∫≠n Thanh To√°n';
                    return;
                }

                // Handle transfer proof image
                let transferProofImage = null;
                const transferProofFile = document.getElementById('transferProof').files[0];

                // Validate transfer proof for bank transfer
                if (paymentMethod === 'bank_transfer') {
                    if (!transferProofFile) {
                        alert('‚ö†Ô∏è Vui l√≤ng t·∫£i l√™n h√¨nh ·∫£nh chuy·ªÉn kho·∫£n!\n\nƒê√¢y l√† y√™u c·∫ßu b·∫Øt bu·ªôc ƒë·ªÉ x√°c nh·∫≠n thanh to√°n.');
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = '<i class="fas fa-university mr-2"></i>X√°c Nh·∫≠n ƒê·∫∑t H√†ng (Chuy·ªÉn Kho·∫£n)';
                        return;
                    }

                    try {
                        transferProofImage = await fileToBase64(transferProofFile);
                        console.log('‚úÖ Transfer proof image converted to base64');
                    } catch (error) {
                        console.error('‚ùå Error converting image:', error);
                        alert('C√≥ l·ªói khi x·ª≠ l√Ω h√¨nh ·∫£nh. Vui l√≤ng th·ª≠ l·∫°i!');
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = '<i class="fas fa-university mr-2"></i>X√°c Nh·∫≠n ƒê·∫∑t H√†ng (Chuy·ªÉn Kho·∫£n)';
                        return;
                    }
                }

                // Calculate totals from real cart data
                const subtotal = cartItems.reduce((sum, item) => {
                    const itemPrice = item.gia || item.price || 0;
                    const itemQuantity = item.qty || item.quantity || item.so_luong || 1;
                    return sum + (itemPrice * itemQuantity);
                }, 0);
                const deliveryFee = orderType === 'giao_hang' ? 20000 : 0;
                const total = subtotal + deliveryFee;

                // Prepare cart items for invoice (normalize format)
                const normalizedCartItems = cartItems.map(item => ({
                    id_mon: item.id_mon || item.id,
                    ten_mon: item.ten_mon || item.name,
                    don_gia: item.gia || item.price,
                    so_luong: item.qty || item.quantity || item.so_luong || 1,
                    thanh_tien: (item.gia || item.price) * (item.qty || item.quantity || item.so_luong || 1),
                    hinh_anh: item.hinh_anh || item.image || 'img/no-image.png'
                }));

                // Generate invoice ID
                const invoiceId = 'inv_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                const invoiceNumber = `HD${String(Math.floor(Math.random() * 1000000)).padStart(6, '0')}`;

                // Create invoice data for local storage
                const invoiceData = {
                    invoice: {
                        id_hoa_don: invoiceId,
                        id_khach: customerInfo.id || 6,
                        ngay_tao: new Date().toISOString(),
                        loai_don: orderType,
                        trang_thai: paymentMethod === 'bank_transfer' ? 'cho_duyet' : 'cho_xac_nhan',
                        tong_tien: total,
                        dia_chi_giao_hang: deliveryAddress || null,
                        ghi_chu: orderNotes || null,
                        payment_method: paymentMethod,
                        payment_status: 'pending',
                        transfer_proof: transferProofImage, // L∆∞u h√¨nh ·∫£nh chuy·ªÉn kho·∫£n
                        customer_info: {
                            full_name: customerInfo.full_name || customerInfo.name || 'Kh√°ch h√†ng',
                            email: customerInfo.email || 'guest@restaurant.com',
                            phone: customerInfo.phone || '0123456789'
                        }
                    },
                    details: normalizedCartItems,
                    timestamp: new Date().toISOString()
                };

                console.log('üöÄ Creating invoice with data:', invoiceData);

                // L∆∞u h√≥a ƒë∆°n v√†o localStorage cho trang danh s√°ch h√≥a ƒë∆°n
                let invoiceList = JSON.parse(localStorage.getItem('invoiceList')) || [];
                invoiceList.unshift(invoiceData); // Th√™m v√†o ƒë·∫ßu danh s√°ch
                localStorage.setItem('invoiceList', JSON.stringify(invoiceList));

                // C≈©ng l∆∞u v√†o invoiceHistory ƒë·ªÉ t∆∞∆°ng th√≠ch
                let invoiceHistory = JSON.parse(localStorage.getItem('invoiceHistory')) || [];
                const historyInvoice = {
                    id: invoiceId,
                    invoiceNumber: invoiceNumber,
                    customerName: customerInfo.full_name || customerInfo.name || 'Kh√°ch h√†ng',
                    customerEmail: customerInfo.email || 'guest@restaurant.com',
                    customerPhone: customerInfo.phone || '0123456789',
                    items: normalizedCartItems,
                    total: total,
                    orderType: orderType === 'giao_hang' ? 'delivery' : 'dine-in',
                    status: paymentMethod === 'bank_transfer' ? 'pending-approval' : 'pending',
                    payment_method: paymentMethod,
                    payment_status: 'pending',
                    createdAt: new Date().toISOString(),
                    address: deliveryAddress || null,
                    notes: orderNotes || null,
                    transfer_proof: transferProofImage // L∆∞u h√¨nh ·∫£nh chuy·ªÉn kho·∫£n
                };
                invoiceHistory.unshift(historyInvoice);
                localStorage.setItem('invoiceHistory', JSON.stringify(invoiceHistory));

                console.log('‚úÖ Invoice saved to localStorage:', {
                    invoiceList: invoiceList.length,
                    invoiceHistory: invoiceHistory.length,
                    hasTransferProof: !!transferProofImage
                });

                // L∆∞u d·ªØ li·ªáu cho trang h√≥a ƒë∆°n
                const orderDataForInvoice = {
                    id: invoiceId,
                    invoiceNumber: invoiceNumber,
                    items: normalizedCartItems,
                    total: total,
                    subtotal: subtotal,
                    deliveryFee: deliveryFee,
                    orderType: orderType,
                    deliveryAddress: deliveryAddress,
                    notes: orderNotes,
                    paymentMethod: paymentMethod,
                    paymentStatus: 'pending',
                    status: paymentMethod === 'bank_transfer' ? 'pending-approval' : 'pending',
                    createdAt: new Date().toISOString(),
                    transfer_proof: transferProofImage,
                    customerInfo: {
                        full_name: customerInfo.full_name || customerInfo.name || 'Kh√°ch h√†ng',
                        email: customerInfo.email || 'guest@restaurant.com',
                        phone: customerInfo.phone || '0123456789'
                    }
                };

                // L∆∞u d·ªØ li·ªáu cho trang h√≥a ƒë∆°n
                localStorage.setItem('currentOrder', JSON.stringify(orderDataForInvoice));
                localStorage.setItem('checkoutCustomerInfo', JSON.stringify(customerInfo));

                // X√≥a gi·ªè h√†ng sau khi thanh to√°n th√†nh c√¥ng
                const currentUserId = getCurrentUserId();
                const cartKey = `cart_${currentUserId}`;

                localStorage.removeItem(cartKey);
                localStorage.removeItem('cart'); // Legacy cart
                localStorage.removeItem('cartData');
                localStorage.removeItem('userCart');

                if (window.cartManager) {
                    window.cartManager.clearCart();
                }

                console.log('‚úÖ Order completed successfully!');

                // Hi·ªÉn th·ªã modal c·∫£m ∆°n
                showSuccessModal(invoiceId);

            } catch (error) {
                console.error('‚ùå Payment error:', error);
                alert('C√≥ l·ªói x·∫£y ra khi thanh to√°n. Vui l√≤ng th·ª≠ l·∫°i!');
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-credit-card mr-2"></i>X√°c Nh·∫≠n Thanh To√°n';
            }
        });

        // Show success modal
        function showSuccessModal(invoiceId) {
            const modal = document.getElementById('successModal');
            const invoiceNumberEl = document.getElementById('invoiceNumber');

            if (invoiceNumberEl) {
                invoiceNumberEl.textContent = `#HD${String(invoiceId).padStart(6, '0')}`;
            }

            if (modal) {
                modal.classList.remove('hidden');
                // Add animation
                modal.style.animation = 'fadeIn 0.3s ease-out';

                // B·∫Øt ƒë·∫ßu countdown
                startCountdown();
            }
        }

        // Countdown timer
        let countdownInterval;
        function startCountdown() {
            let timeLeft = 10;
            const timerEl = document.getElementById('countdownTimer');

            countdownInterval = setInterval(() => {
                timeLeft--;
                if (timerEl) {
                    timerEl.textContent = timeLeft;
                }

                if (timeLeft <= 0) {
                    clearInterval(countdownInterval);
                    const modal = document.getElementById('successModal');
                    if (!modal.classList.contains('hidden')) {
                        console.log('üîÑ Auto redirecting to menu after countdown');
                        closeSuccessModal();
                    }
                }
            }, 1000);
        }

        // Close success modal and redirect to menu
        function closeSuccessModal() {
            // Clear countdown timer
            if (countdownInterval) {
                clearInterval(countdownInterval);
            }

            const modal = document.getElementById('successModal');
            if (modal) {
                modal.style.animation = 'fadeOut 0.3s ease-out';
                setTimeout(() => {
                    modal.classList.add('hidden');
                    // Chuy·ªÉn h∆∞·ªõng v·ªÅ trang menu sau khi thanh to√°n th√†nh c√¥ng
                    console.log('üîÑ Redirecting to menu after successful payment');
                    window.location.href = 'Menu-new.html';
                }, 300);
            }
        }

        // Close modal when clicking outside
        document.addEventListener('click', function(e) {
            const modal = document.getElementById('successModal');
            if (e.target === modal) {
                closeSuccessModal();
            }
        });

        // Handle payment method change
        function handlePaymentMethodChange() {
            const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked').value;
            const bankTransferSection = document.getElementById('bankTransferSection');
            const submitBtn = document.getElementById('submitOrderBtn');
            const transferProofInput = document.getElementById('transferProof');

            if (paymentMethod === 'bank_transfer') {
                bankTransferSection.classList.remove('hidden');
                submitBtn.innerHTML = '<i class="fas fa-university mr-2"></i>X√°c Nh·∫≠n ƒê·∫∑t H√†ng (Chuy·ªÉn Kho·∫£n)';
                transferProofInput.setAttribute('required', 'required');

                // Update transfer content and amount
                updateTransferInfo();
            } else {
                bankTransferSection.classList.add('hidden');
                submitBtn.innerHTML = '<i class="fas fa-credit-card mr-2"></i>X√°c Nh·∫≠n Thanh To√°n';
                transferProofInput.removeAttribute('required');
            }
        }

        // Calculate total amount
        function calculateTotal() {
            const selectedOrderType = document.querySelector('input[name="orderType"]:checked');
            const deliveryFee = (selectedOrderType && selectedOrderType.value === 'giao_hang') ? 20000 : 0;

            const subtotal = cartItems.reduce((sum, item) => {
                const itemPrice = item.gia || item.price || 0;
                const itemQuantity = item.qty || item.quantity || item.so_luong || 1;
                return sum + (itemPrice * itemQuantity);
            }, 0);

            return subtotal + deliveryFee;
        }

        // Format currency
        function formatCurrency(amount) {
            return `${amount.toLocaleString('vi-VN')}ƒë`;
        }

        // Update transfer information
        function updateTransferInfo() {
            const transferContent = document.getElementById('transferContent');
            const transferAmount = document.getElementById('transferAmount');

            if (transferContent && customerInfo) {
                const invoiceNumber = `HD${String(Math.floor(Math.random() * 1000000)).padStart(6, '0')}`;
                transferContent.textContent = `${invoiceNumber} - ${customerInfo.full_name || customerInfo.name || 'Kh√°ch h√†ng'}`;
            }

            if (transferAmount) {
                const total = calculateTotal();
                transferAmount.textContent = formatCurrency(total);
            }
        }

        // Initialize with real data
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üîç Payment page initializing...');

            // Ki·ªÉm tra ƒëƒÉng nh·∫≠p tr∆∞·ªõc ti√™n
            const currentUserId = getCurrentUserId();
            if (!currentUserId) {
                console.log('‚ùå No user logged in, redirecting to menu');
                alert('‚ö†Ô∏è Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ s·ª≠ d·ª•ng ch·ª©c nƒÉng thanh to√°n!');
                window.location.href = 'Menu-new.html';
                return;
            }

            console.log('‚úÖ User logged in:', currentUserId);
            console.log('üîç CartManager available:', typeof CartManager !== 'undefined');

            // Wait for CartManager to be available
            if (typeof CartManager !== 'undefined') {
                if (!window.cartManager) {
                    window.cartManager = new CartManager();
                    console.log('‚úÖ CartManager initialized');
                    console.log('‚úÖ CartManager current user:', window.cartManager.currentUserId);
                    console.log('‚úÖ CartManager cart:', window.cartManager.getCart());
                } else {
                    console.log('‚úÖ CartManager already exists');
                    console.log('‚úÖ Existing CartManager user:', window.cartManager.currentUserId);
                    console.log('‚úÖ Existing CartManager cart:', window.cartManager.getCart());
                }
            } else {
                console.log('‚ùå CartManager not available, using localStorage fallback');
            }

            // Load real data
            loadCustomerInfo();
            loadCartItems();
            updateTotals();

            // Setup event listeners
            setupEventListeners();

            console.log('‚úÖ Payment page initialized with real data');
        });

        // Setup event listeners
        function setupEventListeners() {
            // Payment method change
            document.querySelectorAll('input[name="paymentMethod"]').forEach(radio => {
                radio.addEventListener('change', handlePaymentMethodChange);
            });

            // Order type change
            document.querySelectorAll('input[name="orderType"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    const deliverySection = document.getElementById('deliveryAddressSection');
                    if (this.value === 'giao_hang') {
                        deliverySection.classList.remove('hidden');
                    } else {
                        deliverySection.classList.add('hidden');
                    }
                    updateTotals();

                    // Update transfer amount if bank transfer is selected
                    const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked');
                    if (paymentMethod && paymentMethod.value === 'bank_transfer') {
                        updateTransferInfo();
                    }
                });
            });
        }

        // Debug function to reload cart
        function debugReloadCart() {
            console.log('üîÑ Debug: Reloading cart...');
            console.log('üìã Current localStorage keys:', Object.keys(localStorage));

            // Check all possible cart keys
            const currentUserId = getCurrentUserId();
            const cartKey = `cart_${currentUserId}`;
            console.log('üõí User cart key:', cartKey);
            console.log('üõí User cart data:', localStorage.getItem(cartKey));
            console.log('üõí Legacy cart:', localStorage.getItem('cart'));
            console.log('üõí cartData:', localStorage.getItem('cartData'));
            console.log('üõí userCart:', localStorage.getItem('userCart'));

            // Show all cart_* keys
            console.log('üîç All cart keys in localStorage:');
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('cart_')) {
                    console.log(`  - ${key}: ${localStorage.getItem(key)}`);
                }
            }

            // Force reinitialize CartManager
            if (typeof CartManager !== 'undefined') {
                window.cartManager = new CartManager();
                console.log('üîÑ CartManager reinitialized');
                console.log('üîÑ CartManager user ID:', window.cartManager.currentUserId);
                console.log('üîÑ New cart data:', window.cartManager.getCart());
                console.log('üîÑ Cart length:', window.cartManager.getCart().length);
            }

            // Reload cart data
            loadCartItems();
            updateTotals();
        }

        // Debug function to show all user carts
        function debugShowAllCarts() {
            console.log('üë• Debug: Showing all user carts...');

            const allCarts = {};

            // Find all cart_* keys
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('cart_')) {
                    const userId = key.replace('cart_', '');
                    // B·ªè qua cart c·ªßa guest
                    if (userId === 'guest' || userId === 'null') {
                        console.log(`üóëÔ∏è Skipping guest/null cart: ${key}`);
                        continue;
                    }

                    try {
                        const cartData = JSON.parse(localStorage.getItem(key));
                        allCarts[userId] = {
                            items: cartData,
                            count: cartData.length,
                            key: key
                        };
                        console.log(`üë§ User ${userId}: ${cartData.length} items`);
                        console.log(`   Cart data:`, cartData);
                    } catch (error) {
                        console.error(`‚ùå Error parsing cart for user ${userId}:`, error);
                    }
                }
            }

            console.log('üìä All user carts summary:', allCarts);

            // Show current user info
            const currentUserId = getCurrentUserId();
            console.log(`üîç Current user: ${currentUserId}`);
            console.log(`üõí Current user cart: ${allCarts[currentUserId] ? allCarts[currentUserId].count : 0} items`);

            return allCarts;
        }

        // Function to clean up guest carts
        function cleanupGuestCarts() {
            console.log('üßπ Cleaning up guest carts...');
            const keysToRemove = [];

            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && (key === 'cart_guest' || key === 'cart_null' || key === 'cart_undefined')) {
                    keysToRemove.push(key);
                }
            }

            keysToRemove.forEach(key => {
                localStorage.removeItem(key);
                console.log(`üóëÔ∏è Removed ${key}`);
            });

            console.log(`‚úÖ Cleaned up ${keysToRemove.length} guest cart entries`);
        }
    </script>
</body>
</html>
